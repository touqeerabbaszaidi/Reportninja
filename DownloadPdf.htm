<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
     <script src="JS/jquery-1.8.3.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/jquery.Storage.js"></script>
    <script type="text/javascript" src="js/jquery.jsonp-2.1.3.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            //var userId = getUrlVars()["id"];
            //var userName = getUrlVars()["username"];
            //var reportName = getUrlVars()["reportName"];
            var reportGuid = getUrlVars()["reportGuid"];
            var versionGuid = getUrlVars()["versionGuid"];
            var pageGuid = getUrlVars()["pageGuid"];
            alert("yahoo...");
            $.ajax({
               
                type: "POST",
                //url: "http://projectx.2bvision.com/WebCommunicator/Webservice.asmx/GetSchoolUserByEmailAndPassword",
                url: "WebService.asmx/DownloadPDF",
                //data: "{'id': '" + Id + "'}",
                data: "{'reportGuid':'" + reportGuid + "','versionGuid':'" + versionGuid + "','pageGuid':'" + pageGuid +"'}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (response != null && response != "")
                    {
                        var PageHtml = response.d;
                        var Values = reportGuid + "~" + versionGuid + "~" + pageGuid;
                        GeneratePDF(Values, PageHtml);
                        alert("Report Download");
                    }
                    
                   // window.location = "home.htm?id=" + $.Storage.get("id") + "&username=" + $.Storage.get("username") + "";

                    /*else {
                    alert("No data to display");
                    alert(response.d);
                    }*/
                },
                error: function (e) {
                    $("#Something").html("There was an error retrieving records." + "Error Description:  " + e.d);
                }

            });

        });



        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
        function GeneratePDF(Values, PageHtml) {
            alert("befor download");
            var SplitValues = Values.split('~');
            var Requesti = SplitValues[0];
            var Requestv = SplitValues[1];
            var Requestp = SplitValues[2];
            var Requestr = "";

            var N1 = "";
            var N2 = "";
            var N3 = "";
            var N1GUID = "";
            var N2GUID = "";
            var N3GUID = "";
            var FinalArray = [];
            var FinalArrayGUID = [];
            var OLN1 = PageHtml;
            //var OLN1 = $("#ContentPlaceHolder1_HiddenPagesHTML");
            var OLN1Children = OLN1.children('li');

            OLN1Children.each(function () {
                N1 = $(this).attr("id");
                N1GUID = $("#" + N1 + '_G').val();

                $('#' + N1).children("ol").each(function () {
                    if ($(this).text() == "")
                        $(this).remove();
                });

                var OLN2Html = $(this).html();
                var OLN2Children = $(this).children('ol');
                if (OLN2Children.length == 0) {
                    FinalArray.push(N1 + "~0~0");
                    FinalArrayGUID.push(N1GUID + "~0~0");
                }
                else {
                    OLN2Children.each(function () {
                        var OLN3Html = $(this).html();
                        var LIN3Children = $(this).children('li');

                        LIN3Children.each(function () {
                            N2 = $(this).attr("id");
                            N2GUID = $("#" + N2 + '_G').val();

                            $('#' + N2).children("ol").each(function () {
                                if ($(this).text() == "")
                                    $(this).remove();
                            });
                            var OLN3Children = $(this).children('ol');
                            if (OLN3Children.length == 0) {
                                FinalArray.push(N1 + "~" + N2 + "~0");
                                FinalArrayGUID.push(N1GUID + "~" + N2GUID + "~0");
                            }

                            OLN3Children.each(function () {
                                var OLN4Html = $(this).html();
                                var LIN4Children = $(this).children('li');
                                LIN4Children.each(function () {
                                    N3 = $(this).attr("id");
                                    N3GUID = $("#" + N3 + '_G').val();
                                    FinalArray.push(N1 + "~" + N2 + "~" + N3);
                                    FinalArrayGUID.push(N1GUID + "~" + N2GUID + "~" + N3GUID);
                                });
                            });
                        });
                    });
                }
            });

            var ConcateArray = "";
            var ConcateArrayGUID = "";
            for (var i = 0; i < FinalArray.length; i++) {
                ConcateArray += FinalArray[i] + '^';
            }
            for (var i = 0; i < FinalArrayGUID.length; i++) {
                ConcateArrayGUID += FinalArrayGUID[i] + '^';
            }
            var AllPageIds = ConcateArray.slice(0, -1);
            var AllPageGUIDs = ConcateArrayGUID.slice(0, -1);

            //ajaxSaveBookmarkRecord(AllPageIds, AllPageGUIDs, Requesti, Requestv, Requestp, Requestr);
            return false;
        }
        //Save bookmarks methods
        function ajaxSaveBookmarkRecord(PageIds, PageGUIDs, ReportGUID, VersionGUID, PageGUID, EmailLogGUID) {
            $.ajax({
                type: "POST",
                url: "WebServices/SaveReportHTML.asmx/SaveBookmarkRecord",
                data: "{'PageIds':'" + PageIds + "','PageGUIDs':'" + PageGUIDs + "','ReportGUID': '" + ReportGUID + "','VersionGUID': '" + VersionGUID + "'}",
                contentType: "application/json",
                dataType: "json",
                success: function (msg) {
                    if (msg.d != "Error") {
                        window.location = 'DownloadPDF?g=' + msg.d + '&p=' + PageGUID + '&r=' + EmailLogGUID;
                    }
                }
            });
        }


    </script>

</head>
<body>
</body>
</html>
